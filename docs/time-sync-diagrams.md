# Time Synchronization Diagrams

This document contains detailed ASCII diagrams for the Martos RTOS time synchronization system.

## System Architecture Overview

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           Martos Time Synchronization System                    │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│  │   ESP32 Node    │    │   ESP32-C6 Node │    │   ESP32 Node    │              │
│  │   (Xtensa)      │    │   (RISC-V)      │    │   (Xtensa)      │              │
│  │                 │    │                 │    │                 │              │
│  │ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │              │
│  │ │TimeSyncMgr  │ │    │ │TimeSyncMgr  │ │    │ │TimeSyncMgr  │ │              │
│  │ │             │ │    │ │             │ │    │ │             │ │              │
│  │ │ ┌─────────┐ │ │    │ │ ┌─────────┐ │ │    │ │ ┌─────────┐ │ │              │
│  │ │ │SyncAlg  │ │ │    │ │ │SyncAlg  │ │ │    │ │ │SyncAlg  │ │ │              │
│  │ │ │(LVP)    │ │ │    │ │ │(LVP)    │ │ │    │ │ │(LVP)    │ │ │              │
│  │ │ └─────────┘ │ │    │ │ └─────────┘ │ │    │ │ └─────────┘ │ │              │
│  │ │ ┌─────────┐ │ │    │ │ ┌─────────┐ │ │    │ │ ┌─────────┐ │ │              │
│  │ │ │ESP-NOW  │ │ │    │ │ │ESP-NOW  │ │ │    │ │ │ESP-NOW  │ │ │              │
│  │ │ │Protocol │ │ │    │ │ │Protocol│  │ │    │ │ │Protocol │ │ │              │
│  │ │ └─────────┘ │ │    │ │ └─────────┘ │ │    │ │ └─────────┘ │ │              │
│  │ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │              │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘              │
│           │                       │                       │                     │
│           └───────────────────────┼───────────────────────┘                     │
│                                   │                                             │
│                           ESP-NOW Network                                       │
│                        (Broadcast Messages)                                     │
│                     (All nodes receive all messages)                            │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## Message Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Message Flow Sequence                             │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  Time: 0s                                                                      │
│    │                                                                           │
│    ▼                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        Synchronization Cycle                         │   │
│  │                                                                      │   │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐   │   │
│  │  │   ESP32 Node    │    │   ESP32-C6 Node │    │   ESP32 Node    │   │   │
│  │  │                 │    │                 │    │                 │   │   │
│  │  │ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │   │   │
│  │  │ │ Send        │ │    │ │ Send        │ │    │ │ Send        │ │   │   │
│  │  │ │ Broadcast   │ │    │ │ Broadcast   │ │    │ │ Broadcast   │ │   │   │
│  │  │ │ (Every 2s)  │ │    │ │ (Every 2s)  │ │    │ │ (Every 2s)  │ │   │   │
│  │  │ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │   │   │
│  │  │       │         │    │       │         │    │       │         │   │   │
│  │  │       ▼         │    │       ▼         │    │       ▼         │   │   │
│  │  │ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │   │   │
│  │  │ │ Receive &   │ │    │ │ Receive &   │ │    │ │ Receive &   │ │   │   │
│  │  │ │ Process     │ │◄───┤ │ Process     │ │◄───┤ │ Process     │ │   │   │
│  │  │ │ Messages    │ │    │ │ Messages    │ │    │ │ Messages    │ │   │   │
│  │  │ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │   │   │
│  │  │       │         │    │       │         │    │       │         │   │   │
│  │  │       ▼         │    │       ▼         │    │       ▼         │   │   │
│  │  │ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │   │   │
│  │  │ │ Apply Time  │ │    │ │ Apply Time  │ │    │ │ Apply Time  │ │   │   │
│  │  │ │ Correction  │ │    │ │ Correction  │ │    │ │ Correction  │ │   │   │
│  │  │ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │   │   │
│  │  │       │         │    │       │         │    │       │         │   │   │
│  │  │       ▼         │    │       ▼         │    │       ▼         │   │   │
│  │  │ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │   │   │
│  │  │ │ Update Peer │ │    │ │ Update Peer │ │    │ │ Update Peer │ │   │   │
│  │  │ │ Quality     │ │    │ │ Quality     │ │    │ │ Quality     │ │   │   │
│  │  │ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │   │   │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  Time: 2s                                                                      │
│    │                                                                           │
│    ▼                                                                           │
│  [Repeat Cycle]                                                                │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## Local Voting Protocol Algorithm

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            Local Voting Protocol                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        Algorithm Flow                                 │   │
│  │                                                                         │   │
│  │  1. Receive Time Broadcast                                             │   │
│  │     │                                                                   │   │
│  │     ▼                                                                   │   │
│  │  ┌─────────────────┐                                                    │   │
│  │  │ Parse Message   │                                                    │   │
│  │  │ Extract Time    │                                                    │   │
│  │  └─────────────────┘                                                    │   │
│  │     │                                                                   │   │
│  │     ▼                                                                   │   │
│  │  2. Calculate Time Difference                                          │   │
│  │     │                                                                   │   │
│  │     ▼                                                                   │   │
│  │  ┌─────────────────┐                                                    │   │
│  │  │ time_diff =     │                                                    │   │
│  │  │ received_time - │                                                    │   │
│  │  │ local_time      │                                                    │   │
│  │  └─────────────────┘                                                    │   │
│  │     │                                                                   │   │
│  │     ▼                                                                   │   │
│  │  3. Apply Weighted Consensus                                           │   │
│  │     │                                                                   │   │
│  │     ▼                                                                   │   │
│  │  ┌─────────────────┐                                                    │   │
│  │  │ weighted_diff = │                                                    │   │
│  │  │ Σ(peer.diff *   │                                                    │   │
│  │  │  peer.quality) /│                                                    │   │
│  │  │ Σ(peer.quality) │                                                    │   │
│  │  └─────────────────┘                                                    │   │
│  │     │                                                                   │   │
│  │     ▼                                                                   │   │
│  │  4. Calculate Correction                                                │   │
│  │     │                                                                   │   │
│  │     ▼                                                                   │   │
│  │  ┌─────────────────┐                                                    │   │
│  │  │ if |diff| <=    │                                                    │   │
│  │  │ convergence_th:  │                                                    │   │
│  │  │   correction =   │                                                    │   │
│  │  │   diff * accel   │                                                    │   │
│  │  │ else:            │                                                    │   │
│  │  │   correction =   │                                                    │   │
│  │  │   diff * decel   │                                                    │   │
│  │  └─────────────────┘                                                    │   │
│  │     │                                                                   │   │
│  │     ▼                                                                   │   │
│  │  5. Apply Time Adjustment                                               │   │
│  │     │                                                                   │   │
│  │     ▼                                                                   │   │
│  │  ┌─────────────────┐                                                    │   │
│  │  │ time_offset +=  │                                                    │   │
│  │  │ correction      │                                                    │   │
│  │  │ (Monotonic:     │                                                    │   │
│  │  │  only positive) │                                                    │   │
│  │  └─────────────────┘                                                    │   │
│  │     │                                                                   │   │
│  │     ▼                                                                   │   │
│  │  6. Update Node Quality                                                 │   │
│  │     │                                                                   │   │
│  │     ▼                                                                   │   │
│  │  ┌─────────────────┐                                                    │   │
│  │  │ if correction   │                                                    │   │
│  │  │ < threshold:    │                                                    │   │
│  │  │   quality += 0.1│                                                    │   │
│  │  │ else:           │                                                    │   │
│  │  │   quality -= 0.05│                                                   │   │
│  │  └─────────────────┘                                                    │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## Virtual Time System

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Virtual Time System                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        Time Correction Flow                            │   │
│  │                                                                         │   │
│  │  ┌─────────────────┐                                                    │   │
│  │  │ Hardware Clock │                                                    │   │
│  │  │ (esp_hal::time)│                                                    │   │
│  │  │                │                                                    │   │
│  │  │ Real Time:     │                                                    │   │
│  │  │ 1000000μs      │                                                    │   │
│  │  └─────────────────┘                                                    │   │
│  │     │                                                                   │   │
│  │     ▼                                                                   │   │
│  │  ┌─────────────────┐                                                    │   │
│  │  │ Virtual Offset │                                                    │   │
│  │  │ (time_offset_us)│                                                   │   │
│  │  │                │                                                    │   │
│  │  │ Offset: +50000μs│                                                    │   │
│  │  └─────────────────┘                                                    │   │
│  │     │                                                                   │   │
│  │     ▼                                                                   │   │
│  │  ┌─────────────────┐                                                    │   │
│  │  │ Corrected Time  │                                                    │   │
│  │  │ (real + offset) │                                                    │   │
│  │  │                │                                                    │   │
│  │  │ Result:        │                                                    │   │
│  │  │ 1050000μs      │                                                    │   │
│  │  └─────────────────┘                                                    │   │
│  │                                                                         │   │
│  │  ┌─────────────────┐                                                    │   │
│  │  │ Application     │                                                    │   │
│  │  │ Uses Corrected  │                                                    │   │
│  │  │ Time            │                                                    │   │
│  │  └─────────────────┘                                                    │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        Correction Application                          │   │
│  │                                                                         │   │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐   │   │
│  │  │ Before Sync     │    │ During Sync     │    │ After Sync      │   │   │
│  │  │                 │    │                 │    │                 │   │   │
│  │  │ Real: 1000000μs │    │ Real: 1000000μs │    │ Real: 1000000μs │   │   │
│  │  │ Offset: 0μs     │    │ Offset: +25000μs│    │ Offset: +50000μs│   │   │
│  │  │ Corrected:      │    │ Corrected:      │    │ Corrected:      │   │   │
│  │  │ 1000000μs       │    │ 1025000μs       │    │ 1050000μs       │   │   │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## Network Topology Examples

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            Network Topology Examples                           │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        Star Topology                                   │   │
│  │                                                                         │   │
│  │                    ┌─────────────────┐                                 │   │
│  │                    │   ESP32-C6      │                                 │   │
│  │                    │   (Master)      │                                 │   │
│  │                    └─────────────────┘                                 │   │
│  │                           │                                             │   │
│  │                           │                                             │   │
│  │        ┌──────────────────┼──────────────────┐                          │   │
│  │        │                  │                  │                          │   │
│  │        ▼                  ▼                  ▼                          │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                     │   │
│  │  │   ESP32     │  │   ESP32     │  │   ESP32     │                     │   │
│  │  │   (Node 1)  │  │   (Node 2)  │  │   (Node 3)  │                     │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                     │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        Mesh Topology                                   │   │
│  │                                                                         │   │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                 │   │
│  │  │   ESP32     │◄──►│   ESP32-C6  │◄──►│   ESP32     │                 │   │
│  │  │   (Node 1)  │    │   (Node 2)  │    │   (Node 3)  │                 │   │
│  │  └─────────────┘    └─────────────┘    └─────────────┘                 │   │
│  │        │                   │                   │                       │   │
│  │        │                   │                   │                       │   │
│  │        ▼                   ▼                   ▼                       │   │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                 │   │
│  │  │   ESP32     │    │   ESP32     │    │   ESP32-C6  │                 │   │
│  │  │   (Node 4)  │    │   (Node 5)  │    │   (Node 6)  │                 │   │
│  │  └─────────────┘    └─────────────┘    └─────────────┘                 │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        Ring Topology                                   │   │
│  │                                                                         │   │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                 │   │
│  │  │   ESP32     │◄──►│   ESP32-C6  │◄──►│   ESP32     │                 │   │
│  │  │   (Node 1)  │    │   (Node 2)  │    │   (Node 3)  │                 │   │
│  │  └─────────────┘    └─────────────┘    └─────────────┘                 │   │
│  │        ▲                   │                   │                       │   │
│  │        │                   │                   │                       │   │
│  │        │                   │                   │                       │   │
│  │        └───────────────────┼───────────────────┘                       │   │
│  │                            │                                           │   │
│  │                            ▼                                           │   │
│  │                      ┌─────────────┐                                   │   │
│  │                      │   ESP32     │                                   │   │
│  │                      │   (Node 4)  │                                   │   │
│  │                      └─────────────┘                                   │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```


## Cross-Platform Communication

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          Cross-Platform Communication                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        Platform Compatibility                          │   │
│  │                                                                         │   │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐   │   │
│  │  │ ESP32 (Xtensa)  │    │ ESP32-C6 (RISC-V)│    │ ESP32-S2 (Xtensa)│   │   │
│  │  │                 │    │                 │    │                 │   │   │
│  │  │ Architecture:   │    │ Architecture:   │    │ Architecture:   │   │   │
│  │  │ Xtensa LX6      │    │ RISC-V RV32IMAC│    │ Xtensa LX7      │   │   │
│  │  │                 │    │                 │    │                 │   │   │
│  │  │ ESP-NOW: ✅     │    │ ESP-NOW: ✅     │    │ ESP-NOW: ✅     │   │   │
│  │  │ Time Sync: ✅   │    │ Time Sync: ✅   │    │ Time Sync: ✅   │   │   │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        Communication Flow                              │   │
│  │                                                                         │   │
│  │  ┌─────────────────┐           ┌─────────────────┐                     │   │
│  │  │ ESP32 (Xtensa)  │           │ ESP32-C6 (RISC-V)│                     │   │
│  │  │                 │           │                 │                     │   │
│  │  │ ┌─────────────┐ │           │ ┌─────────────┐ │                     │   │
│  │  │ │ Martos API │ │           │ │ Martos API │ │                     │   │
│  │  │ │ (Same)     │ │           │ │ (Same)     │ │                     │   │
│  │  │ └─────────────┘ │           │ └─────────────┘ │                     │   │
│  │  │       │         │           │       │         │                     │   │
│  │  │       ▼         │           │       ▼         │                     │   │
│  │  │ ┌─────────────┐ │           │ ┌─────────────┐ │                     │   │
│  │  │ │ ESP-NOW    │ │◄──────────►│ │ ESP-NOW    │ │                     │   │
│  │  │ │ Protocol   │ │           │ │ Protocol   │ │                     │   │
│  │  │ │ (Same)     │ │           │ │ (Same)     │ │                     │   │
│  │  │ └─────────────┘ │           │ └─────────────┘ │                     │   │
│  │  │       │         │           │       │         │                     │   │
│  │  │       ▼         │           │       ▼         │                     │   │
│  │  │ ┌─────────────┐ │           │ ┌─────────────┐ │                     │   │
│  │  │ │ Hardware    │ │           │ │ Hardware    │ │                     │   │
│  │  │ │ (Different) │ │           │ │ (Different) │ │                     │   │
│  │  │ └─────────────┘ │           │ └─────────────┘ │                     │   │
│  │  └─────────────────┘           └─────────────────┘                     │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## Troubleshooting Flow

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Troubleshooting Flow                               │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        Problem Diagnosis                               │   │
│  │                                                                         │   │
│  │  ┌─────────────────┐                                                    │   │
│  │  │ No Sync         │                                                    │   │
│  │  │                 │                                                    │   │
│  │  │ Check:          │                                                    │   │
│  │  │ • ESP-NOW range │                                                    │   │
│  │  │ • Peer MACs     │                                                    │   │
│  │  │ • Sync enabled  │                                                    │   │
│  │  └─────────────────┘                                                    │   │
│  │     │                                                                   │   │
│  │     ▼                                                                   │   │
│  │  ┌─────────────────┐                                                    │   │
│  │  │ Poor Quality    │                                                    │   │
│  │  │                 │                                                    │   │
│  │  │ Check:          │                                                    │   │
│  │  │ • Network       │                                                    │   │
│  │  │ • Config params │                                                    │   │
│  │  │ • Clock drift   │                                                    │   │
│  │  └─────────────────┘                                                    │   │
│  │     │                                                                   │   │
│  │     ▼                                                                   │   │
│  │  ┌─────────────────┐                                                    │   │
│  │  │ Large Corrections│                                                    │   │
│  │  │                 │                                                    │   │
│  │  │ Check:          │                                                    │   │
│  │  │ • Initial sync  │                                                    │   │
│  │  │ • Network delay │                                                    │   │
│  │  │ • Clock drift   │                                                    │   │
│  │  └─────────────────┘                                                    │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        Solution Application                             │   │
│  │                                                                         │   │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐   │   │
│  │  │ Adjust Config   │    │ Monitor Stats   │    │ Debug Output    │   │   │
│  │  │                 │    │                 │    │                 │   │   │
│  │  │ • Sync interval │    │ • Quality score │    │ • Time diff      │   │   │
│  │  │ • Correction    │    │ • Peer count    │    │ • Offset value   │   │   │
│  │  │ • Factors       │    │ • Convergence   │    │ • Correction    │   │   │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

*These diagrams provide a visual representation of the Martos RTOS time synchronization system architecture, algorithms, and operational flow.*
